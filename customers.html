<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Customer Manager</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --bg-color: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Inter', sans-serif; 
            color: #1e293b;
            padding-bottom: 90px;
            -webkit-font-smoothing: antialiased;
        }

        /* RESPONSIVE CONTAINER */
        .app-container { 
            max-width: 600px; /* Default Mobile Width */
            margin: 0 auto; 
            min-height: 100vh; 
        }

        /* HEADER */
        .header { background: white; padding: 20px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #e2e8f0; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-input { padding-left: 45px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; height: 50px; font-size: 1rem; width: 100%; transition: all 0.2s; }
        .search-input:focus { border-color: #6366f1; background: white; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* CUSTOMER CARD */
        .customer-card { 
            background: white; border-radius: 12px; padding: 16px; 
            margin-bottom: 12px; 
            display: flex; align-items: center; justify-content: space-between; 
            border: 1px solid #f1f5f9; cursor: pointer; transition: transform 0.1s; 
        }
        .customer-card:active { transform: scale(0.98); background-color: #fafafa; }
        .customer-card:hover { border-color: #6366f1; } /* Desktop Hover Effect */
        
        .avatar { width: 45px; height: 45px; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #4338ca; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; margin-right: 15px; }
        .cust-info h5 { margin: 0; font-size: 1rem; font-weight: 600; }
        .cust-info p { margin: 0; font-size: 0.85rem; color: #64748b; }
        
        .stamp-badge { background: #f0fdf4; color: #166534; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; border: 1px solid #dcfce7; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; padding: 10px 0; display: flex; justify-content: center; gap: 40px; z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94a3b8; font-size: 0.75rem; font-weight: 500; min-width: 60px; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: #4f46e5; }

        /* MODAL */
        .modal-content { border-radius: 20px; border: none; }
        .stamp-control { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
        .stamp-display { font-size: 2.5rem; font-weight: 700; color: #1e293b; width: 80px; text-align: center; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #e2e8f0; background: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #475569; transition: all 0.2s; }

        /* --- DESKTOP UPGRADES --- */
        @media (min-width: 768px) {
            .app-container { 
                max-width: 1000px; /* Wider container */
                padding-top: 20px;
            }
            .header {
                background: transparent; border: none; position: static;
                display: flex; align-items: center; justify-content: space-between;
                margin-bottom: 20px;
            }
            .search-box { width: 300px; }
            
            /* GRID LAYOUT FOR CARDS */
            #customerList {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
            }
            .customer-card { margin-bottom: 0; height: 100%; box-shadow: var(--card-shadow); }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="header">
        <div class="d-flex align-items-center">
            <h4 class="m-0 fw-bold me-3">Customers</h4>
            <span class="badge bg-primary rounded-pill" id="total-count">0</span>
        </div>
        <div class="search-box mt-3 mt-md-0">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search name or ID..." onkeyup="filterCustomers()">
        </div>
    </div>

    <div class="container-fluid px-0" id="customerList">
        </div>

</div>

<div class="bottom-nav">
    <a href="index.html" class="nav-item">
        <i class="bi bi-gear-fill"></i>
        <span>Settings</span>
    </a>
    <a href="customers.html" class="nav-item active">
        <i class="bi bi-people-fill"></i>
        <span>Customers</span>
    </a>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Edit Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center pt-0 pb-4">
                <input type="hidden" id="edit-id">
                <div class="avatar mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.5rem;" id="modal-avatar">?</div>
                <h4 id="edit-name" class="fw-bold mb-1">Name</h4>
                <p class="text-muted" id="edit-record">ID: 0</p>
                
                <div class="stamp-control">
                    <button class="btn-circle" onclick="adjustStamps(-1)"><i class="bi bi-dash"></i></button>
                    <div class="stamp-display" id="edit-stamps">0</div>
                    <button class="btn-circle" onclick="adjustStamps(1)"><i class="bi bi-plus"></i></button>
                </div>
                <div class="d-grid gap-2 mt-4">
                    <button onclick="saveChanges()" class="btn btn-primary btn-lg rounded-4 fw-bold" style="background: var(--primary-gradient); border:none;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- JS LOGIC SAME AS PREVIOUS ---
    const SUPABASE_URL = 'https://buwlmaslsirvobttszew.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_kIpp1DgcWVdcL5le1lc_Hg_Aw-vQtEl'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let allCustomers = [];
    let editModalObj = null;

    async function init() {
        editModalObj = new bootstrap.Modal(document.getElementById('editModal'));
        await fetchCustomers();
    }

    async function fetchCustomers() {
        const { data, error } = await supabaseClient.from('Customers').select('*').order('customer_record', { ascending: true });
        if (!error) {
            allCustomers = data;
            document.getElementById('total-count').innerText = data.length;
            renderList(allCustomers);
        }
    }

    function renderList(data) {
        const container = document.getElementById('customerList');
        container.innerHTML = '';
        if(data.length === 0) {
            container.innerHTML = '<div class="text-center mt-5 text-muted w-100"><p>No customers found.</p></div>';
            return;
        }
        data.forEach(cust => {
            const initials = (cust.first_name || '?').charAt(0) + (cust.last_name || '').charAt(0);
            const fullName = `${cust.first_name || 'Unknown'} ${cust.last_name || ''}`;
            
            const card = document.createElement('div');
            card.className = 'customer-card';
            card.onclick = () => openEdit(cust);
            card.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="avatar">${initials.toUpperCase()}</div>
                    <div class="cust-info">
                        <h5>${fullName}</h5>
                        <p>ID: ${cust.customer_record}</p>
                    </div>
                </div>
                <div class="stamp-badge"><i class="bi bi-star-fill me-1"></i>${cust.total_stamps || 0}</div>
            `;
            container.appendChild(card);
        });
    }

    function filterCustomers() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allCustomers.filter(c => {
            const name = (c.first_name + ' ' + c.last_name).toLowerCase();
            const id = String(c.customer_record);
            return name.includes(query) || id.includes(query);
        });
        renderList(filtered);
    }

    function openEdit(customer) {
        document.getElementById('edit-id').value = customer.customer_record;
        document.getElementById('edit-name').innerText = `${customer.first_name} ${customer.last_name}`;
        document.getElementById('edit-record').innerText = `Record #${customer.customer_record}`;
        document.getElementById('edit-stamps').innerText = customer.total_stamps || 0;
        
        const initials = (customer.first_name || '?').charAt(0) + (customer.last_name || '').charAt(0);
        document.getElementById('modal-avatar').innerText = initials.toUpperCase();
        
        editModalObj.show();
    }

    function adjustStamps(amount) {
        const el = document.getElementById('edit-stamps');
        let val = parseInt(el.innerText) + amount;
        if(val < 0) val = 0;
        el.innerText = val;
    }

    async function saveChanges() {
        const recordId = document.getElementById('edit-id').value;
        const newStamps = parseInt(document.getElementById('edit-stamps').innerText);
        const btn = document.querySelector('#editModal .btn-primary');
        const oldText = btn.innerText;
        btn.innerText = "Saving..."; btn.disabled = true;

        const { error } = await supabaseClient.from('Customers').update({ total_stamps: newStamps }).eq('customer_record', recordId);
        if(!error) {
            const idx = allCustomers.findIndex(c => c.customer_record == recordId);
            if(idx !== -1) allCustomers[idx].total_stamps = newStamps;
            renderList(allCustomers); filterCustomers(); editModalObj.hide();
        }
        btn.innerText = oldText; btn.disabled = false;
    }
    init();
</script>
</body>
</html>